<!DOCTYPE html>
<html lang="en">
<head>
	<!-- Global site tag (gtag.js) - Google Analytics -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-38933930-6"></script>
	<script src="https://code.jquery.com/jquery-3.5.1.min.js"
			  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
			  crossorigin="anonymous"></script>
	<script type="text/javascript">
// window.dataLayer = window.dataLayer || [];
// function gtag(){dataLayer.push(arguments);}
// gtag('js', new Date());
// gtag('config', 'UA-38933930-6');
	</script>

	<script type="text/javascript">
"use strict";

var map, infoWindow;

var ui = {
	route_lines: [],
	waypoints: [],
	soc_icons: []
};

function make_estimate(origin, destination)
{
	$.get(origin + "/" + destination + "/estimate", function(data) {
		console.log(data);

		for (var i = 0; i < data.length - 1; i++)
		{
			var route_coords = [];
			route_coords.push({lat: data[i][0], lng: data[i][1]}, {lat: data[i+1][0], lng: data[i+1][1]});

			var soc = parseInt(Math.max(0, data[i][2]) * 100);
			var g = parseInt(soc * 2.55).toString(16);
			var r = parseInt((100 - soc) * 2.55).toString(16);
			if (g.length < 2) { g += '0'; }
			if (r.length < 2) { r += '0'; }

			if (i == 0 || i == parseInt(data.length / 2) || soc == 0 || i ==
        data.length - 2)
			{
				var soc_marker = new google.maps.InfoWindow;
				soc_marker.setPosition({lat: data[i][0], lng: data[i][1]});
				soc_marker.setContent(parseInt(100 * data[i][2]) + '% ðŸ”‹' );
				soc_marker.open(map);
				ui.soc_icons.push(soc_marker);
			}

			if (soc <= 0) { break; }

			console.log(data[i][2] + " #" + r + g + "00");

			  const route_path = new google.maps.Polyline({
			    path: route_coords,
			    geodesic: true,
			    strokeColor: "#" + r + g + "00",
			    strokeOpacity: 1.0,
			    strokeWeight: 2,
			  });
			  route_path.setMap(map);

			ui.route_lines.push(route_path);
		}
	});
}

function clear_map_estimate()
{
	for (var i = ui.route_lines.length; i--;)
	{
		ui.route_lines[i].setMap(null);
	}
	ui.route_lines = [];

	for (var i = ui.waypoints.length; i--;)
	{
		ui.waypoints[i].setMap(null);
	}
	ui.waypoints = [];

	for (var i = ui.soc_icons.length; i--;)
	{
		ui.soc_icons[i].setMap(null);
	}
	ui.soc_icons = [];
}

function init_map() {
	map = new google.maps.Map(document.getElementById("map"), {
	  center: {
		lat: 0,
		lng: 0
	  },
	  zoom: 8
	});

	infoWindow = new google.maps.InfoWindow;

	map.addListener('click', (event) => {
		if (ui.waypoints.length >= 2)
		{
			clear_map_estimate();
			return;
		}

		var marker = new google.maps.Marker({
			position: event.latLng,
			map: map,
			title: ui.waypoints.length > 0 ? 'Stop ' + ui.waypoints.length : 'Start'
		});
		marker.position.str = function() {
			return marker.position.lat() + "," + marker.position.lng(); 
		};
		ui.waypoints.push(marker);

		if (ui.waypoints.length == 2)
		{
			make_estimate(ui.waypoints[0].position.str(), ui.waypoints[1].position.str());
		}
	})

	if (navigator.geolocation)
	{
		navigator.geolocation.getCurrentPosition(function(position) {
			var pos = {
				lat: position.coords.latitude,
				lng: position.coords.longitude
			};

			infoWindow.setPosition(pos);
			infoWindow.setContent('Location found.');
			infoWindow.open(map);
			map.setCenter(pos);
		},
		function() {
			handleLocationError(true, infoWindow, map.getCenter());
		});
	}
	else
	{
		// Browser doesn't support Geolocation
		handleLocationError(false, infoWindow, map.getCenter());
	}

	// handle resize
	window.onresize = function() {$('#map').height(window.innerHeight-100)}
	window.onresize();
}

function handleLocationError(browserHasGeolocation, infoWindow, pos)
{
	infoWindow.setPosition(pos);
	infoWindow.setContent(browserHasGeolocation ?
	'Error: The Geolocation service failed.' :
	'Error: Your browser doesn\'t support geolocation.');
	infoWindow.open(map);
}


	</script>

	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>
	RÎ©HM - Trip planner
	</title>

	<!--<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"/>-->
	<link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet">
	<link href="css/style.css" rel="stylesheet">
</head>

<body class="container-fluid">
<header class="row">
<h1><center><a href="/">RÎ©HM</a><center></h1>
</header>

<main>
<div id="map"></div>
</main>

<footer>
<center>
Â© Kirk Roerig 2020
</center>
</footer>

</body>

	<script
	  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAKwDXQvVOVmEfgRHsT4ah6uEfNC76nymE&callback=init_map&libraries=visualization"
	  defer
	></script>

</html>

